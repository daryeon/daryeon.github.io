<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>网络流量抓包库gopacket介绍 - 大叶的博客</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="darye" />
  <meta name="description" content="简介 gopacket是什么？ gopacket是google出品的golang三方库，质量还是靠的住，项目地址为：github.com/goo" />

  <meta name="keywords" content="darye, blog, golang" />






<meta name="generator" content="Hugo 0.81.0" />


<link rel="canonical" href="https://daryeon.github.io/post/go-library-gopacket/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="网络流量抓包库gopacket介绍" />
<meta property="og:description" content="简介 gopacket是什么？ gopacket是google出品的golang三方库，质量还是靠的住，项目地址为：github.com/goo" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://daryeon.github.io/post/go-library-gopacket/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-03-25T06:56:44&#43;08:00" />
<meta property="article:modified_time" content="2021-03-25T06:56:44&#43;08:00" />

<meta itemprop="name" content="网络流量抓包库gopacket介绍">
<meta itemprop="description" content="简介 gopacket是什么？ gopacket是google出品的golang三方库，质量还是靠的住，项目地址为：github.com/goo"><meta itemprop="datePublished" content="2021-03-25T06:56:44&#43;08:00" />
<meta itemprop="dateModified" content="2021-03-25T06:56:44&#43;08:00" />
<meta itemprop="wordCount" content="3889">
<meta itemprop="keywords" content="library," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="网络流量抓包库gopacket介绍"/>
<meta name="twitter:description" content="简介 gopacket是什么？ gopacket是google出品的golang三方库，质量还是靠的住，项目地址为：github.com/goo"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'FnqQug9uRJOY3m-RDZahKQ', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">大叶</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/daryeon" rel="noopener" target="_blank">
              GitHub&#39;s
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          <div class="mobile-menu-parent">
            <span class="mobile-submenu-open"></span>
            <a href="https://daryeon.github.io/">
              docs
            </a>
          </div>
          <ul class="mobile-submenu-list">
            
              <li>
                <a href="https://daryeon.github.io/post/composer-and-aotuload/">Composer和自动加载学习分享</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-small-details/">Go的一些小细节</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/encode-introduce/">unicode,ascii,utf-8编码的区别</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/pjax-introduce/">如何将Pjax整合进网站，实现全站无刷新加载？</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/curl-error-code-77/">curl请求HTTPS网站时返回false,错误码为77</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-zhizhen-introduce/">Go语言中的指针介绍</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-libraray-phpquery/">phpQuery—基于jQuery的PHP实现</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-modify-file-opcache/">PHP修改文件但是不生效，可能是opcache的问题</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-namespace/">PHP的命名空间讲解</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-date-function-used/">php获取当月天数及当月第一天及最后一天、上月第一天及最后一天实现方法</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/base-on-php-_and_symbol-skill/">基于php&amp;运算符的巧妙应用</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-redis-distributed-lock/">基于redis实现分布式锁</a>
              </li>
            
          </ul>
        
      </li><li class="mobile-menu-item">
        
          
          <div class="mobile-menu-parent">
            <span class="mobile-submenu-open"></span>
            <a href="https://daryeon.github.io/">
              go-library
            </a>
          </div>
          <ul class="mobile-submenu-list">
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-go-queue/">分布式任务&#43;消息队列框架go-queue</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-gopacket/">网络流量抓包库gopacket介绍</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-lumberjack/">日志切割组件库lumberjack介绍</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-commonregex/">Go 正则表达式库之 commonregex</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-goleak/">Goroutine泄漏防治神器goleak介绍</a>
              </li>
            
          </ul>
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      大叶
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/daryeon" rel="noopener" target="_blank">
              GitHub&#39;s
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://daryeon.github.io/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          <a class="menu-item-link menu-parent" href="https://daryeon.github.io/">docs</a>
          <ul class="submenu">
            
              <li>
                <a href="https://daryeon.github.io/post/composer-and-aotuload/">Composer和自动加载学习分享</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-small-details/">Go的一些小细节</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/encode-introduce/">unicode,ascii,utf-8编码的区别</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/pjax-introduce/">如何将Pjax整合进网站，实现全站无刷新加载？</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/curl-error-code-77/">curl请求HTTPS网站时返回false,错误码为77</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-zhizhen-introduce/">Go语言中的指针介绍</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-libraray-phpquery/">phpQuery—基于jQuery的PHP实现</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-modify-file-opcache/">PHP修改文件但是不生效，可能是opcache的问题</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-namespace/">PHP的命名空间讲解</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-date-function-used/">php获取当月天数及当月第一天及最后一天、上月第一天及最后一天实现方法</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/base-on-php-_and_symbol-skill/">基于php&amp;运算符的巧妙应用</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/php-redis-distributed-lock/">基于redis实现分布式锁</a>
              </li>
            
          </ul>

        

      </li>
    
        <li class="menu-item active">
        
          
          <a class="menu-item-link menu-parent" href="https://daryeon.github.io/">go-library</a>
          <ul class="submenu">
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-go-queue/">分布式任务&#43;消息队列框架go-queue</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-gopacket/">网络流量抓包库gopacket介绍</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-lumberjack/">日志切割组件库lumberjack介绍</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-commonregex/">Go 正则表达式库之 commonregex</a>
              </li>
            
              <li>
                <a href="https://daryeon.github.io/post/go-library-goleak/">Goroutine泄漏防治神器goleak介绍</a>
              </li>
            
          </ul>

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">网络流量抓包库gopacket介绍</h1>
      
      <div class="post-meta">
        <time datetime="2021-03-25" class="post-time">
          2021-03-25
        </time>
        <div class="post-category">
            <a href="https://daryeon.github.io/categories/go/"> go </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#简介">简介</a></li>
        <li><a href="#安装部署">安装部署</a></li>
        <li><a href="#使用方法">使用方法</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h3 id="简介">简介</h3>
<ol>
<li>gopacket是什么？</li>
</ol>
<p>gopacket是google出品的golang三方库，质量还是靠的住，项目地址为：github.com/google/gopacket</p>
<p>gopacket到底是什么呢？是个抓取网络数据包的库，这么说可能还有点抽象，但是抓包工具大家可能都使用过。</p>
<p>Windows平台下有Wireshark抓包工具，其底层抓包库是npcap（以前是winpcap）；</p>
<p>Linux平台下有Tcpdump，其抓包库是libpcap；</p>
<p>而gopacket库可以说是libpcap和npcap的go封装，提供了更方便的go语言操作接口。</p>
<p>对于抓包库来说，常规功能就是抓包，而网络抓包有以下几个步骤：</p>
<ul>
<li>1、枚举主机上网络设备的接口</li>
<li>2、针对某一网口进行抓包</li>
<li>3、解析数据包的mac层、ip层、tcp/udp层字段等</li>
<li>4、ip分片重组，或tcp分段重组成上层协议如http协议的数据</li>
<li>5、对上层协议进行头部解析和负载部分解析</li>
</ul>
<ol start="2">
<li>应用场景有哪些？</li>
</ol>
<p>场景1：网络流量分析</p>
<p>对网络设备流量进行实时采集以及数据包分析。</p>
<p>场景2：伪造数据包</p>
<p>不少网络安全工具，需要伪造网络数据包，填充上必要的协议字段后发送给对端设备，从而达到一些目的。</p>
<p>场景3：离线pcap文件的读取和写入</p>
<h3 id="安装部署">安装部署</h3>
<ol start="3">
<li>安装libpcap或npcap三方库</li>
</ol>
<p>在使用gopacket包时，首先要确保在windows平台下安装了npcap或winpcap，或者是在linux平台下安装了libpcap库。</p>
<p>npcap下载地址：<a href="https://nmap.org/npcap/">https://nmap.org/npcap/</a></p>
<p>libpcap下载地址: <a href="https://www.tcpdump.org/">https://www.tcpdump.org/</a></p>
<p>下载自己电脑对应的操作系统版本的库</p>
<p>如果不想从官网下载libpcap库的话，也可以采用centos的yum命令或ubuntu的apt get命令来进行安装。</p>
<ol start="4">
<li>安装gopacket库</li>
</ol>
<pre><code>go get github.com/google/gopacket
</code></pre><h3 id="使用方法">使用方法</h3>
<ol start="5">
<li>枚举网络设备</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;log&#34;</span>
    <span style="color:#e6db74">&#34;github.com/google/gopacket/pcap&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// 得到所有的(网络)设备
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">devices</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pcap</span>.<span style="color:#a6e22e">FindAllDevs</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
    }
    <span style="color:#75715e">// 打印设备信息
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Devices found:&#34;</span>)
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">device</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">devices</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;\nName: &#34;</span>, <span style="color:#a6e22e">device</span>.<span style="color:#a6e22e">Name</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Description: &#34;</span>, <span style="color:#a6e22e">device</span>.<span style="color:#a6e22e">Description</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Devices addresses: &#34;</span>, <span style="color:#a6e22e">device</span>.<span style="color:#a6e22e">Description</span>)
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">address</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">device</span>.<span style="color:#a6e22e">Addresses</span> {
            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;- IP address: &#34;</span>, <span style="color:#a6e22e">address</span>.<span style="color:#a6e22e">IP</span>)
            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;- Subnet mask: &#34;</span>, <span style="color:#a6e22e">address</span>.<span style="color:#a6e22e">Netmask</span>)
        }
    }
}
</code></pre></div><p>先调用pcap.FindAllDevs()获取当前主机所有的网络设备，网络设备有哪些属性呢？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Interface describes a single network interface on a machine.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Interface</span> <span style="color:#66d9ef">struct</span> {
 <span style="color:#a6e22e">Name</span>        <span style="color:#66d9ef">string</span> <span style="color:#75715e">//设备名称
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">Description</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">//设备描述信息
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">Flags</span>       <span style="color:#66d9ef">uint32</span> 
 <span style="color:#a6e22e">Addresses</span>   []<span style="color:#a6e22e">InterfaceAddress</span> <span style="color:#75715e">//网口的地址信息列表
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">// InterfaceAddress describes an address associated with an Interface.
</span><span style="color:#75715e">// Currently, it&#39;s IPv4/6 specific.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">InterfaceAddress</span> <span style="color:#66d9ef">struct</span> {
 <span style="color:#a6e22e">IP</span>        <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IP</span>
 <span style="color:#a6e22e">Netmask</span>   <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IPMask</span> <span style="color:#75715e">// Netmask may be nil if we were unable to retrieve it.
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">Broadaddr</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IP</span>     <span style="color:#75715e">// Broadcast address for this IP may be nil
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">P2P</span>       <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IP</span>     <span style="color:#75715e">// P2P destination address for this IP may be nil
</span><span style="color:#75715e"></span>}
</code></pre></div><ol start="6">
<li>打开一个设备进行抓包</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;github.com/google/gopacket&#34;</span>
    <span style="color:#e6db74">&#34;github.com/google/gopacket/pcap&#34;</span>
    <span style="color:#e6db74">&#34;log&#34;</span>
    <span style="color:#e6db74">&#34;time&#34;</span>
)
<span style="color:#66d9ef">var</span> (
    <span style="color:#a6e22e">device</span>       <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;eth0&#34;</span>
    <span style="color:#a6e22e">snapshot_len</span> <span style="color:#66d9ef">int32</span>  = <span style="color:#ae81ff">1024</span>
    <span style="color:#a6e22e">promiscuous</span>  <span style="color:#66d9ef">bool</span>   = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">err</span>          <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">timeout</span>      <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span> = <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>
    <span style="color:#a6e22e">handle</span>       <span style="color:#f92672">*</span><span style="color:#a6e22e">pcap</span>.<span style="color:#a6e22e">Handle</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// 打开某一网络设备
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pcap</span>.<span style="color:#a6e22e">OpenLive</span>(<span style="color:#a6e22e">device</span>, <span style="color:#a6e22e">snapshot_len</span>, <span style="color:#a6e22e">promiscuous</span>, <span style="color:#a6e22e">timeout</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>) }
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">handle</span>.<span style="color:#a6e22e">Close</span>()
    <span style="color:#75715e">// Use the handle as a packet source to process all packets
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">packetSource</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">NewPacketSource</span>(<span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">handle</span>.<span style="color:#a6e22e">LinkType</span>())
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">packet</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">packetSource</span>.<span style="color:#a6e22e">Packets</span>() {
        <span style="color:#75715e">// Process packet here
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">packet</span>)
    }
}
</code></pre></div><p>6.1. 实时捕获</p>
<p>3.0节中我们枚举了当前主机的所有网络设备，现在需要打开网络设备并进行实时捕获数据包，需调用pcap.OpenLive来打开网络设备，其函数原型如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OpenLive</span>(<span style="color:#a6e22e">device</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">snaplen</span> <span style="color:#66d9ef">int32</span>, <span style="color:#a6e22e">promisc</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">timeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) (<span style="color:#a6e22e">handle</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Handle</span>, <span style="color:#a6e22e">_</span> <span style="color:#66d9ef">error</span>)
</code></pre></div><p>device:网络设备的名称，如eth0,也可以填充pcap.FindAllDevs()返回的设备的Name</p>
<p>snaplen: 每个数据包读取的最大长度 the maximum size to read for each packet</p>
<p>promisc:是否将网口设置为混杂模式,即是否接收目的地址不为本机的包</p>
<p>timeout:设置抓到包返回的超时。如果设置成30s，那么每30s才会刷新一次数据包；设置成负数，会立刻刷新数据包，即不做等待</p>
<p>函数返回值：是一个*Handle类型的返回值，可能作为gopacket其他函数调用时作为函数参数来传递。</p>
<p>注意事项：</p>
<p>一定要记得释放掉handle，如文中的defer handle.Close()。</p>
<p>6.2. 创建数据包源</p>
<p>packetSource := gopacket.NewPacketSource(handle, handle.LinkType())</p>
<p>第一个参数为OpenLive的返回值，指向Handle类型的指针变量handle。</p>
<p>第二个参数为handle.LinkType()此参数默认是以太网链路，一般我们抓包，也是从2层以太网链路上抓取。</p>
<p>6.3. 读取数据包</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//packetSource.Packets()是个channel类型，此处是从channel类型的数据通道中持续的读取网络数据包
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">packet</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">packetSource</span>.<span style="color:#a6e22e">Packets</span>() {
  <span style="color:#75715e">// Process packet here
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">packet</span>)
}
</code></pre></div><ol start="7">
<li>解码数据包的各层</li>
</ol>
<p>我们可以获取原始数据包，并尝试将其强制转换为已知格式。如ethernet、IP和TCP层。</p>
<p>Layers包是gopacket的Go库中的新功能，在底层libpcap库中不存在。它是gopacket库的非常有用的一部分。它允许我们轻松地识别数据包是否包含特定类型的层。这个代码示例将演示如何使用layers包来查看包是否是ethernet、IP和TCP，以及如何轻松访问这些头中的字段。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;github.com/google/gopacket&#34;</span>
    <span style="color:#e6db74">&#34;github.com/google/gopacket/layers&#34;</span>
    <span style="color:#e6db74">&#34;github.com/google/gopacket/pcap&#34;</span>
    <span style="color:#e6db74">&#34;log&#34;</span>
    <span style="color:#e6db74">&#34;strings&#34;</span>
    <span style="color:#e6db74">&#34;time&#34;</span>
)
<span style="color:#66d9ef">var</span> (
    <span style="color:#a6e22e">device</span>      <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;eth0&#34;</span>
    <span style="color:#a6e22e">snapshotLen</span> <span style="color:#66d9ef">int32</span>  = <span style="color:#ae81ff">1024</span>
    <span style="color:#a6e22e">promiscuous</span> <span style="color:#66d9ef">bool</span>   = <span style="color:#66d9ef">false</span>
    <span style="color:#a6e22e">err</span>         <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">timeout</span>     <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span> = <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>
    <span style="color:#a6e22e">handle</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">pcap</span>.<span style="color:#a6e22e">Handle</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// Open device
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pcap</span>.<span style="color:#a6e22e">OpenLive</span>(<span style="color:#a6e22e">device</span>, <span style="color:#a6e22e">snapshotLen</span>, <span style="color:#a6e22e">promiscuous</span>, <span style="color:#a6e22e">timeout</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>) }
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">handle</span>.<span style="color:#a6e22e">Close</span>()
    <span style="color:#a6e22e">packetSource</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">NewPacketSource</span>(<span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">handle</span>.<span style="color:#a6e22e">LinkType</span>())
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">packet</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">packetSource</span>.<span style="color:#a6e22e">Packets</span>() {
        <span style="color:#a6e22e">printPacketInfo</span>(<span style="color:#a6e22e">packet</span>)
    }
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">printPacketInfo</span>(<span style="color:#a6e22e">packet</span> <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">Packet</span>) {
    <span style="color:#75715e">// Let&#39;s see if the packet is an ethernet packet
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 判断数据包是否为以太网数据包，可解析出源mac地址、目的mac地址、以太网类型（如ip类型）等
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ethernetLayer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">Layer</span>(<span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">LayerTypeEthernet</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ethernetLayer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Ethernet layer detected.&#34;</span>)
        <span style="color:#a6e22e">ethernetPacket</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ethernetLayer</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">Ethernet</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Source MAC: &#34;</span>, <span style="color:#a6e22e">ethernetPacket</span>.<span style="color:#a6e22e">SrcMAC</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Destination MAC: &#34;</span>, <span style="color:#a6e22e">ethernetPacket</span>.<span style="color:#a6e22e">DstMAC</span>)
        <span style="color:#75715e">// Ethernet type is typically IPv4 but could be ARP or other
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Ethernet type: &#34;</span>, <span style="color:#a6e22e">ethernetPacket</span>.<span style="color:#a6e22e">EthernetType</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
    }
    <span style="color:#75715e">// Let&#39;s see if the packet is IP (even though the ether type told us)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 判断数据包是否为IP数据包，可解析出源ip、目的ip、协议号等
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ipLayer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">Layer</span>(<span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">LayerTypeIPv4</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ipLayer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;IPv4 layer detected.&#34;</span>)
        <span style="color:#a6e22e">ip</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ipLayer</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">IPv4</span>)
        <span style="color:#75715e">// IP layer variables:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Version (Either 4 or 6)
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// IHL (IP Header Length in 32-bit words)
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// TOS, Length, Id, Flags, FragOffset, TTL, Protocol (TCP?),
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Checksum, SrcIP, DstIP
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;From %s to %s\n&#34;</span>, <span style="color:#a6e22e">ip</span>.<span style="color:#a6e22e">SrcIP</span>, <span style="color:#a6e22e">ip</span>.<span style="color:#a6e22e">DstIP</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Protocol: &#34;</span>, <span style="color:#a6e22e">ip</span>.<span style="color:#a6e22e">Protocol</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
    }
    <span style="color:#75715e">// Let&#39;s see if the packet is TCP
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 判断数据包是否为TCP数据包，可解析源端口、目的端口、seq序列号、tcp标志位等
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tcpLayer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">Layer</span>(<span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">LayerTypeTCP</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tcpLayer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;TCP layer detected.&#34;</span>)
        <span style="color:#a6e22e">tcp</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tcpLayer</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">TCP</span>)
        <span style="color:#75715e">// TCP layer variables:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// SrcPort, DstPort, Seq, Ack, DataOffset, Window, Checksum, Urgent
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Bool flags: FIN, SYN, RST, PSH, ACK, URG, ECE, CWR, NS
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;From port %d to %d\n&#34;</span>, <span style="color:#a6e22e">tcp</span>.<span style="color:#a6e22e">SrcPort</span>, <span style="color:#a6e22e">tcp</span>.<span style="color:#a6e22e">DstPort</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Sequence number: &#34;</span>, <span style="color:#a6e22e">tcp</span>.<span style="color:#a6e22e">Seq</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
    }
    <span style="color:#75715e">// Iterate over all layers, printing out each layer type
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;All packet layers:&#34;</span>)
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">layer</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">Layers</span>() {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;- &#34;</span>, <span style="color:#a6e22e">layer</span>.<span style="color:#a6e22e">LayerType</span>())
    }
    <span style="color:#75715e">///.......................................................
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Check for errors
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 判断layer是否存在错误
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">ErrorLayer</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error decoding some part of the packet:&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
}
</code></pre></div><p>仅仅以此处tcp部分的代码详细解析下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 判断数据包是否为TCP数据包，可解析源端口、目的端口、seq序列号、tcp标志位等
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tcpLayer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">Layer</span>(<span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">LayerTypeTCP</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tcpLayer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;TCP layer detected.&#34;</span>)
        <span style="color:#a6e22e">tcp</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tcpLayer</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">TCP</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;From port %d to %d\n&#34;</span>, <span style="color:#a6e22e">tcp</span>.<span style="color:#a6e22e">SrcPort</span>, <span style="color:#a6e22e">tcp</span>.<span style="color:#a6e22e">DstPort</span>)
    }
</code></pre></div><p>此处需要研究下源代码中数据结构，以防理解错误</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Packet</span> <span style="color:#66d9ef">interface</span> {
 <span style="color:#75715e">// Layer returns the first layer in this packet of the given type, or nil
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">Layer</span>(<span style="color:#a6e22e">LayerType</span>) <span style="color:#a6e22e">Layer</span>   <span style="color:#75715e">//根据给定的类型，在数据包中寻找其第一个层
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">//看看Layer的结构
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Layer</span> <span style="color:#66d9ef">interface</span> {
 <span style="color:#75715e">// LayerType is the gopacket type for this layer.
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">LayerType</span>() <span style="color:#a6e22e">LayerType</span>
 <span style="color:#75715e">// LayerContents returns the set of bytes that make up this layer.
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">LayerContents</span>() []<span style="color:#66d9ef">byte</span>
 <span style="color:#75715e">// LayerPayload returns the set of bytes contained within this layer, not
</span><span style="color:#75715e"></span> <span style="color:#75715e">// including the layer itself.
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">LayerPayload</span>() []<span style="color:#66d9ef">byte</span>
}
<span style="color:#75715e">//tcp数据包格式
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">TCP</span> <span style="color:#66d9ef">struct</span> {
 <span style="color:#a6e22e">BaseLayer</span>
 <span style="color:#a6e22e">SrcPort</span>, <span style="color:#a6e22e">DstPort</span>                           <span style="color:#a6e22e">TCPPort</span>
 <span style="color:#a6e22e">Seq</span>                                        <span style="color:#66d9ef">uint32</span>
 <span style="color:#a6e22e">Ack</span>                                        <span style="color:#66d9ef">uint32</span>
 <span style="color:#a6e22e">DataOffset</span>                                 <span style="color:#66d9ef">uint8</span>
 <span style="color:#a6e22e">FIN</span>, <span style="color:#a6e22e">SYN</span>, <span style="color:#a6e22e">RST</span>, <span style="color:#a6e22e">PSH</span>, <span style="color:#a6e22e">ACK</span>, <span style="color:#a6e22e">URG</span>, <span style="color:#a6e22e">ECE</span>, <span style="color:#a6e22e">CWR</span>, <span style="color:#a6e22e">NS</span> <span style="color:#66d9ef">bool</span>
 <span style="color:#a6e22e">Window</span>                                     <span style="color:#66d9ef">uint16</span>
 <span style="color:#a6e22e">Checksum</span>                                   <span style="color:#66d9ef">uint16</span>
 <span style="color:#a6e22e">Urgent</span>                                     <span style="color:#66d9ef">uint16</span>
 <span style="color:#a6e22e">sPort</span>, <span style="color:#a6e22e">dPort</span>                               []<span style="color:#66d9ef">byte</span>
 <span style="color:#a6e22e">Options</span>                                    []<span style="color:#a6e22e">TCPOption</span>
 <span style="color:#a6e22e">Padding</span>                                    []<span style="color:#66d9ef">byte</span>
 <span style="color:#a6e22e">opts</span>                                       [<span style="color:#ae81ff">4</span>]<span style="color:#a6e22e">TCPOption</span>
 <span style="color:#a6e22e">tcpipchecksum</span>
}
</code></pre></div><p>TCP结构体是实现了Layer接口的，其实Ethernet，IPV4，UDP等结构体也实现了Layer接口</p>
<p>在上述代码中，我们调用函数时，传入的LayerType协议层的类型为layers.LayerTypeTCP，函数返回值为interface类型，必须转换成TCP结构体</p>
<p>tcp, _ := tcpLayer.(*layers.TCP)</p>
<p>tcp是layers.TCP这个具体类型的指针，通过tcp则可以获取数据包中tcp协议的相关字段。</p>
<ol start="8">
<li>自定义层</li>
</ol>
<p>自定义层有助于实现当前不包含在gopacket layers包中的协议。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;github.com/google/gopacket&#34;</span>
)
<span style="color:#75715e">// 创建自定义层数据结构，并实现Layer接口中的函数LayerType()、LayerContents()、LayerPayload()
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CustomLayer</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#75715e">// This layer just has two bytes at the front
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">SomeByte</span>    <span style="color:#66d9ef">byte</span>
    <span style="color:#a6e22e">AnotherByte</span> <span style="color:#66d9ef">byte</span>
    <span style="color:#a6e22e">restOfData</span>  []<span style="color:#66d9ef">byte</span>
}
<span style="color:#75715e">// 注册自定义层类型，然后我们才可以使用它
</span><span style="color:#75715e">// 第一个参数是ID. 自定义层使用大于2000的数字，它必须是唯一的
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">CustomLayerType</span> = <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">RegisterLayerType</span>(
    <span style="color:#ae81ff">2001</span>,
    <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">LayerTypeMetadata</span>{
        <span style="color:#e6db74">&#34;CustomLayerType&#34;</span>,
        <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">DecodeFunc</span>(<span style="color:#a6e22e">decodeCustomLayer</span>),
    },
)

<span style="color:#75715e">//自定义层实现LayerType
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#a6e22e">CustomLayer</span>) <span style="color:#a6e22e">LayerType</span>() <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">LayerType</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">CustomLayerType</span>
}

<span style="color:#75715e">//自定义层实现LayerContents
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#a6e22e">CustomLayer</span>) <span style="color:#a6e22e">LayerContents</span>() []<span style="color:#66d9ef">byte</span> {
    <span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">byte</span>{<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">SomeByte</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">AnotherByte</span>}
}

<span style="color:#75715e">//自定义层实现LayerPayload
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#a6e22e">CustomLayer</span>) <span style="color:#a6e22e">LayerPayload</span>() []<span style="color:#66d9ef">byte</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">restOfData</span>
}

<span style="color:#75715e">//实现自定义的解码函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">decodeCustomLayer</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">PacketBuilder</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">AddLayer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">CustomLayer</span>{<span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">2</span>:]})
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">NextDecoder</span>(<span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">LayerTypePayload</span>)
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">rawBytes</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x0F</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">67</span>, <span style="color:#ae81ff">68</span>}
    <span style="color:#a6e22e">packet</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">NewPacket</span>(
        <span style="color:#a6e22e">rawBytes</span>,
        <span style="color:#a6e22e">CustomLayerType</span>,
        <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">Default</span>,
    )
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Created packet out of raw bytes.&#34;</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">packet</span>)
    <span style="color:#75715e">// Decode the packet as our custom layer
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">customLayer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">Layer</span>(<span style="color:#a6e22e">CustomLayerType</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">customLayer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Packet was successfully decoded with custom layer decoder.&#34;</span>)
        <span style="color:#a6e22e">customLayerContent</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">customLayer</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">CustomLayer</span>)
        <span style="color:#75715e">// Now we can access the elements of the custom struct
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Payload: &#34;</span>, <span style="color:#a6e22e">customLayerContent</span>.<span style="color:#a6e22e">LayerPayload</span>())
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;SomeByte element:&#34;</span>, <span style="color:#a6e22e">customLayerContent</span>.<span style="color:#a6e22e">SomeByte</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;AnotherByte element:&#34;</span>, <span style="color:#a6e22e">customLayerContent</span>.<span style="color:#a6e22e">AnotherByte</span>)
    }
}
</code></pre></div><p>结合上述代码可知，实现自定义的层需要3步：</p>
<p>1、创建自定义层的结构体，并实现Layer接口中的函数LayerType()、LayerContents()、LayerPayload()</p>
<p>2、按照解码函数签名来实现自定义解码函数，名称可自行命名。</p>
<p>解码函数签名如下：</p>
<p>type DecodeFunc func([]byte, PacketBuilder) error</p>
<p>3、使用gopacket.RegisterLayerType函数来注册自定义层</p>
<ol start="9">
<li>TCP流重组</li>
</ol>
<p>为什么需要tcp流重组？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
 <span style="color:#e6db74">&#34;bufio&#34;</span>
 <span style="color:#e6db74">&#34;flag&#34;</span>
 <span style="color:#e6db74">&#34;io&#34;</span>
 <span style="color:#e6db74">&#34;log&#34;</span>
 <span style="color:#e6db74">&#34;net/http&#34;</span>
 <span style="color:#e6db74">&#34;time&#34;</span>

 <span style="color:#e6db74">&#34;github.com/google/gopacket&#34;</span>
 <span style="color:#e6db74">&#34;github.com/google/gopacket/examples/util&#34;</span>
 <span style="color:#e6db74">&#34;github.com/google/gopacket/layers&#34;</span>
 <span style="color:#e6db74">&#34;github.com/google/gopacket/pcap&#34;</span>
 <span style="color:#e6db74">&#34;github.com/google/gopacket/tcpassembly&#34;</span>
 <span style="color:#e6db74">&#34;github.com/google/gopacket/tcpassembly/tcpreader&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">iface</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;i&#34;</span>, <span style="color:#e6db74">&#34;eth0&#34;</span>, <span style="color:#e6db74">&#34;Interface to get packets from&#34;</span>)
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaplen</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Int</span>(<span style="color:#e6db74">&#34;s&#34;</span>, <span style="color:#ae81ff">1600</span>, <span style="color:#e6db74">&#34;SnapLen for pcap packet capture&#34;</span>)

<span style="color:#75715e">// Build a simple HTTP request parser using tcpassembly.StreamFactory and tcpassembly.Stream interfaces
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// httpStreamFactory implements tcpassembly.StreamFactory
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">httpStreamFactory</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#75715e">// httpStream will handle the actual decoding of http requests.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">httpStream</span> <span style="color:#66d9ef">struct</span> {
 <span style="color:#a6e22e">net</span>, <span style="color:#a6e22e">transport</span> <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">Flow</span>
 <span style="color:#a6e22e">r</span>              <span style="color:#a6e22e">tcpreader</span>.<span style="color:#a6e22e">ReaderStream</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">httpStreamFactory</span>) <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">net</span>, <span style="color:#a6e22e">transport</span> <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">Flow</span>) <span style="color:#a6e22e">tcpassembly</span>.<span style="color:#a6e22e">Stream</span> {
 <span style="color:#a6e22e">hstream</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">httpStream</span>{
  <span style="color:#a6e22e">net</span>:       <span style="color:#a6e22e">net</span>,
  <span style="color:#a6e22e">transport</span>: <span style="color:#a6e22e">transport</span>,
  <span style="color:#a6e22e">r</span>:         <span style="color:#a6e22e">tcpreader</span>.<span style="color:#a6e22e">NewReaderStream</span>(),
 }
 <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">hstream</span>.<span style="color:#a6e22e">run</span>() <span style="color:#75715e">// Important... we must guarantee that data from the reader stream is read.
</span><span style="color:#75715e"></span>
 <span style="color:#75715e">// ReaderStream implements tcpassembly.Stream, so we can return a pointer to it.
</span><span style="color:#75715e"></span> <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">hstream</span>.<span style="color:#a6e22e">r</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">httpStream</span>) <span style="color:#a6e22e">run</span>() {
 <span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">r</span>)
 <span style="color:#66d9ef">for</span> {
  <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ReadRequest</span>(<span style="color:#a6e22e">buf</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
   <span style="color:#75715e">// We must read until we see an EOF... very important!
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">return</span>
  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error reading stream&#34;</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">net</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">transport</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">err</span>)
  } <span style="color:#66d9ef">else</span> {
   <span style="color:#a6e22e">bodyBytes</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tcpreader</span>.<span style="color:#a6e22e">DiscardBytesToEOF</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Body</span>)
   <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Received request from stream&#34;</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">net</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">transport</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">req</span>, <span style="color:#e6db74">&#34;with&#34;</span>, <span style="color:#a6e22e">bodyBytes</span>, <span style="color:#e6db74">&#34;bytes in request body&#34;</span>)
  }
 }
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
 <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Run</span>()()
 <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">handle</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pcap</span>.<span style="color:#a6e22e">Handle</span>
 <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>

 <span style="color:#75715e">// Set up pcap packet capture
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pcap</span>.<span style="color:#a6e22e">OpenLive</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">iface</span>, int32(<span style="color:#f92672">*</span><span style="color:#a6e22e">snaplen</span>), <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">pcap</span>.<span style="color:#a6e22e">BlockForever</span>)
 <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
 }

 <span style="color:#75715e">// Set up assembly
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">streamFactory</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">httpStreamFactory</span>{}
 <span style="color:#a6e22e">streamPool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tcpassembly</span>.<span style="color:#a6e22e">NewStreamPool</span>(<span style="color:#a6e22e">streamFactory</span>)
 <span style="color:#a6e22e">assembler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tcpassembly</span>.<span style="color:#a6e22e">NewAssembler</span>(<span style="color:#a6e22e">streamPool</span>)

 <span style="color:#75715e">// Read in packets, pass to assembler.
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">packetSource</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gopacket</span>.<span style="color:#a6e22e">NewPacketSource</span>(<span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">handle</span>.<span style="color:#a6e22e">LinkType</span>())
 <span style="color:#a6e22e">packets</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">packetSource</span>.<span style="color:#a6e22e">Packets</span>()
 <span style="color:#a6e22e">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Tick</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>)
 <span style="color:#66d9ef">for</span> {
  <span style="color:#66d9ef">select</span> {
  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">packet</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">packets</span>:
   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">NetworkLayer</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">TransportLayer</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">TransportLayer</span>().<span style="color:#a6e22e">LayerType</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">LayerTypeTCP</span> {
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Unusable packet&#34;</span>)
    <span style="color:#66d9ef">continue</span>
   }
   <span style="color:#a6e22e">tcp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">TransportLayer</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">layers</span>.<span style="color:#a6e22e">TCP</span>)
   <span style="color:#75715e">//将数据包进行重组
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">assembler</span>.<span style="color:#a6e22e">AssembleWithTimestamp</span>(<span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">NetworkLayer</span>().<span style="color:#a6e22e">NetworkFlow</span>(), <span style="color:#a6e22e">tcp</span>, <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">Metadata</span>().<span style="color:#a6e22e">Timestamp</span>)

  <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ticker</span>:
   <span style="color:#75715e">//每隔一分钟，刷新之前两分钟内不活动的连接
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">assembler</span>.<span style="color:#a6e22e">FlushOlderThan</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span> <span style="color:#f92672">*</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>))
  }
 }
}
</code></pre></div><p>基本步骤如下：</p>
<p>1、创建httpStreamFactory结构体，实现tcpassembly.StreamFactory接口</p>
<p>2、创建连接池</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">streamPool</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tcpassembly</span>.<span style="color:#a6e22e">NewStreamPool</span>(<span style="color:#a6e22e">streamFactory</span>)
</code></pre></div><p>3、创建重组器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">assembler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tcpassembly</span>.<span style="color:#a6e22e">NewAssembler</span>(<span style="color:#a6e22e">streamPool</span>)
</code></pre></div><p>4、将数据包添加到重组器中</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">assembler</span>.<span style="color:#a6e22e">AssembleWithTimestamp</span>(<span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">NetworkLayer</span>().<span style="color:#a6e22e">NetworkFlow</span>(), <span style="color:#a6e22e">tcp</span>, <span style="color:#a6e22e">packet</span>.<span style="color:#a6e22e">Metadata</span>().<span style="color:#a6e22e">Timestamp</span>)
</code></pre></div><h3 id="总结">总结</h3>
<p>首先，gopacket库是google大厂背书，从使用文档、质量、社区活跃度来说都很不错</p>
<p>其次，使用方式简单，扩展性好。gopacket提供了自定义的接口，可根据自身需要进行定制化开发</p>
<p>最后，gopacket定义的layers齐全，如果是实时捕获数据后进行协议解析，采用其内置的layer即可，无需自己手动去解析繁杂的协议了。</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">darye</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2021-03-25
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a href="https://github.com/gohugoio/hugoBasicExample" rel="noopener" target="_blank">See origin</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://daryeon.github.io/tags/library/">library</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/go-library-lumberjack/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">日志切割组件库lumberjack介绍</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/go-library-go-queue/">
            <span class="next-text nav-default">分布式任务&#43;消息队列框架go-queue</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:infeeling208@email.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/daryeon" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://daryeon.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        darye
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>



  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>









  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
